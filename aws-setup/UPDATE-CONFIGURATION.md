# æ›´æ–°é…ç½®è¯´æ˜ - CloudFormation å¯¹ ECS çš„å½±å“

## ğŸ“‹ æ¦‚è¿°

å½“ä½ æ›´æ–° `parameters.production.json` å¹¶è¿è¡Œéƒ¨ç½²è„šæœ¬æ—¶ï¼ŒCloudFormation ä¼šæ›´æ–°ç›¸å…³èµ„æºã€‚æœ¬æ–‡æ¡£è¯´æ˜ä¸åŒé…ç½®å˜æ›´å¯¹ ECS æœåŠ¡çš„å½±å“ã€‚

---

## ğŸ”„ æ›´æ–°æµç¨‹

```bash
# 1. æ›´æ–°å‚æ•°æ–‡ä»¶
# ç¼–è¾‘ parameters.production.jsonï¼Œä¿®æ”¹éœ€è¦æ›´æ–°çš„å€¼

# 2. è¿è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆåªæ›´æ–°ç›¸å…³å †æ ˆï¼‰
./deploy-with-parameters.sh production
```

**å…³é”®ç‚¹**ï¼š
- âœ… éƒ¨ç½²è„šæœ¬ä¼šæ£€æµ‹å †æ ˆå˜åŒ–ï¼Œåªæ›´æ–°æœ‰å˜æ›´çš„å †æ ˆ
- âœ… ECS ç›¸å…³å˜æ›´ä¼šè§¦å‘ä»»åŠ¡å®šä¹‰æ›´æ–°å’ŒæœåŠ¡æ»šåŠ¨éƒ¨ç½²
- âœ… **å®¹å™¨å†…å®¹æ˜¯ ECR é•œåƒï¼Œä¸æ˜¯"æŒ‚è½½"çš„**ï¼ˆè¯¦è§ä¸‹æ–¹è¯´æ˜ï¼‰

---

## ğŸ“Š ä¸åŒé…ç½®å˜æ›´çš„å½±å“

### 1. **ECS ç¡¬ä»¶é…ç½®å˜æ›´**ï¼ˆCPU/Memoryï¼‰

**ç¤ºä¾‹**ï¼šå°† `FargateCpu` ä» `512` æ”¹ä¸º `1024`

**å‘ç”Ÿä»€ä¹ˆ**ï¼š
1. CloudFormation åˆ›å»ºæ–°çš„**ä»»åŠ¡å®šä¹‰ revision**ï¼ˆä»»åŠ¡å®šä¹‰ä¸å¯å˜ï¼‰
2. ECS æœåŠ¡æ£€æµ‹åˆ°æ–°ä»»åŠ¡å®šä¹‰
3. **æ»šåŠ¨æ›´æ–°å¼€å§‹**ï¼š
   - å¯åŠ¨æ–°å®¹å™¨ï¼ˆä½¿ç”¨æ–°ç¡¬ä»¶ï¼š1 vCPU + 2 GBï¼‰
   - ç­‰å¾…æ–°å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡
   - åœæ­¢æ—§å®¹å™¨ï¼ˆ0.5 vCPU + 1 GBï¼‰

**æ—¶é—´**ï¼šçº¦ 2-5 åˆ†é’Ÿï¼ˆå–å†³äºåº”ç”¨å¯åŠ¨æ—¶é—´ï¼‰

**å½±å“**ï¼š
- âœ… **é›¶åœæœº**ï¼ˆå¦‚æœé…ç½®äº†å¥åº·æ£€æŸ¥å’Œæ»šåŠ¨æ›´æ–°ï¼‰
- âœ… **åº”ç”¨ä»£ç ä¸å˜**ï¼ˆä½¿ç”¨ç›¸åŒçš„ ECR é•œåƒï¼‰
- âš ï¸ **çŸ­æš‚çš„æœåŠ¡ä¸­æ–­**ï¼ˆå¦‚æœåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼‰
- âœ… **è‡ªåŠ¨å›æ»š**ï¼ˆå¦‚æœæ–°å®¹å™¨æŒç»­å¤±è´¥ï¼ŒCircuit Breaker ä¼šå›æ»šï¼‰

---

### 2. **ç¯å¢ƒå˜é‡å˜æ›´**ï¼ˆDBPassword, CORSOrigin, LogLevel ç­‰ï¼‰

**ç¤ºä¾‹**ï¼šæ›´æ–° `DBPassword` æˆ– `CORSOrigin`

**å‘ç”Ÿä»€ä¹ˆ**ï¼š
1. åˆ›å»ºæ–°çš„ä»»åŠ¡å®šä¹‰ revisionï¼ˆåŒ…å«æ–°çš„ç¯å¢ƒå˜é‡ï¼‰
2. ECS æœåŠ¡æ»šåŠ¨æ›´æ–°
3. æ–°å®¹å™¨å¯åŠ¨æ—¶ä½¿ç”¨æ–°çš„ç¯å¢ƒå˜é‡
4. **åº”ç”¨éœ€è¦é‡å¯**æ‰èƒ½ä½¿ç”¨æ–°é…ç½®

**å½±å“**ï¼š
- âœ… é…ç½®ç«‹å³ç”Ÿæ•ˆï¼ˆæ–°å®¹å™¨ä½¿ç”¨æ–°å€¼ï¼‰
- âš ï¸ éœ€è¦åº”ç”¨æ”¯æŒç¯å¢ƒå˜é‡çƒ­æ›´æ–°ï¼ˆéƒ¨åˆ†åº”ç”¨éœ€è¦é‡å¯ï¼‰
- âœ… Node.js åº”ç”¨é€šå¸¸éœ€è¦é‡å¯æ‰èƒ½è¯»å–æ–°çš„ç¯å¢ƒå˜é‡

---

### 3. **RDS é…ç½®å˜æ›´**ï¼ˆDBInstanceClass, DBAllocatedStorageï¼‰

**ç¤ºä¾‹**ï¼šå°† `DBInstanceClass` ä» `db.t3.micro` æ”¹ä¸º `db.t3.small`

**å‘ç”Ÿä»€ä¹ˆ**ï¼š
1. RDS å®ä¾‹**ä¿®æ”¹ç±»å‹**ï¼ˆmodifyï¼‰
2. **RDS é‡å¯**ï¼ˆçº¦ 5-10 åˆ†é’Ÿï¼‰
3. æ•°æ®åº“è¿æ¥çŸ­æš‚ä¸­æ–­
4. ECS å®¹å™¨ä¼šè‡ªåŠ¨é‡è¿ï¼ˆå¦‚æœåº”ç”¨æœ‰é‡è¯•æœºåˆ¶ï¼‰

**å½±å“**ï¼š
- âš ï¸ **RDS çŸ­æš‚ä¸å¯ç”¨**ï¼ˆ5-10 åˆ†é’Ÿï¼‰
- âš ï¸ **ECS æœåŠ¡å¯èƒ½å—å½±å“**ï¼ˆå¦‚æœæ•°æ®åº“è¿æ¥ä¸­æ–­ï¼‰
- âœ… **å®¹å™¨å’Œæ•°æ®éƒ½ä¸å˜**ï¼ˆåªæ˜¯ç¡¬ä»¶å‡çº§ï¼‰

---

### 4. **ALB é…ç½®å˜æ›´**ï¼ˆACMCertificateArnï¼‰

**ç¤ºä¾‹**ï¼šæ›´æ–° ACM è¯ä¹¦ ARN

**å‘ç”Ÿä»€ä¹ˆ**ï¼š
1. ALB HTTPS ç›‘å¬å™¨æ›´æ–°è¯ä¹¦
2. **ä¸å½±å“ ECS æœåŠ¡**ï¼ˆALB æ˜¯å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼‰
3. å¯èƒ½æœ‰å‡ ç§’é’Ÿçš„è¯ä¹¦åˆ‡æ¢

**å½±å“**ï¼š
- âœ… **é›¶å½±å“**ECS å®¹å™¨
- âœ… æ›´æ–°å®Œæˆå³å¯

---

## ğŸ¯ å…³é”®æ¦‚å¿µè¯´æ˜

### âŒ **ä¸æ˜¯"æŒ‚è½½"æ¦‚å¿µ**

ECS Fargate ä½¿ç”¨**å®¹å™¨é•œåƒ**ï¼Œä¸æ˜¯"æŒ‚è½½ç¡¬ç›˜"ï¼š

```
å®¹å™¨å¯åŠ¨æµç¨‹ï¼š
1. ECS ä» ECR æ‹‰å– Docker é•œåƒ
2. åˆ›å»ºæ–°çš„å®¹å™¨å®ä¾‹ï¼ˆåŸºäºé•œåƒï¼‰
3. åº”ç”¨ä»£ç åœ¨å®¹å™¨å†…éƒ¨è¿è¡Œ
4. å®¹å™¨åœæ­¢åï¼Œæ‰€æœ‰å†…å®¹éƒ½æ¶ˆå¤±ï¼ˆé™¤äº†æ—¥å¿—ï¼‰

âŒ ä¸æ˜¯ï¼š
[æ—§ç¡¬ç›˜] --æŒ‚è½½--> [æ–°å®¹å™¨]

âœ… å®é™…æ˜¯ï¼š
[ECR é•œåƒ] --> [æ–°å®¹å™¨å®ä¾‹] --> [è¿è¡Œåº”ç”¨]
[æ—§å®¹å™¨] --> [åœæ­¢å¹¶åˆ é™¤]
```

### âœ… **æ»šåŠ¨æ›´æ–°æœºåˆ¶**

æ ¹æ® `ecs-services.yaml` ä¸­çš„é…ç½®ï¼š

```yaml
DeploymentConfiguration:
  MaximumPercent: 200        # æœ€å¤š 200% ä»»åŠ¡ï¼ˆå¦‚ DesiredCount=1ï¼Œæœ€å¤š 2 ä¸ªï¼‰
  MinimumHealthyPercent: 50  # è‡³å°‘ 50% å¥åº·ï¼ˆå¦‚ DesiredCount=1ï¼Œè‡³å°‘ 1 ä¸ªï¼‰
  DeploymentCircuitBreaker:
    Enable: true
    Rollback: true            # å¤±è´¥è‡ªåŠ¨å›æ»š
```

**æ»šåŠ¨æ›´æ–°è¿‡ç¨‹**ï¼ˆDesiredCount=1ï¼‰ï¼š
1. å¯åŠ¨æ–°ä»»åŠ¡ï¼ˆæ€»æ•° = 2ï¼Œè¶…è¿‡ DesiredCount=1ï¼‰
2. ç­‰å¾…æ–°ä»»åŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
3. åœæ­¢æ—§ä»»åŠ¡ï¼ˆæ€»æ•° = 1ï¼‰
4. æ›´æ–°å®Œæˆ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **CPU/Memory å˜æ›´ä¸ä¼šæ”¹å˜åº”ç”¨ä»£ç **

- å®¹å™¨é•œåƒæ¥è‡ª ECRï¼ˆéœ€è¦å•ç‹¬æ›´æ–°ï¼‰
- æ›´æ–°ç¡¬ä»¶é…ç½® â‰  æ›´æ–°åº”ç”¨ä»£ç 
- è¦æ›´æ–°åº”ç”¨ä»£ç ï¼Œéœ€è¦ï¼š
  ```bash
  # 1. æ„å»ºæ–°é•œåƒ
  docker build -t xituan-backend:new-version .
  
  # 2. æ¨é€åˆ° ECR
  docker push <ECR_URI>:new-version
  
  # 3. æ›´æ–° ECS ä»»åŠ¡å®šä¹‰ä¸­çš„é•œåƒæ ‡ç­¾
  # ï¼ˆé€šè¿‡ GitHub Actions æˆ–æ‰‹åŠ¨æ›´æ–°ï¼‰
  ```

### 2. **ç¯å¢ƒå˜é‡å˜æ›´éœ€è¦åº”ç”¨é‡å¯**

- Node.js åº”ç”¨åœ¨å¯åŠ¨æ—¶è¯»å–ç¯å¢ƒå˜é‡
- å˜æ›´ç¯å¢ƒå˜é‡åï¼Œå®¹å™¨ä¼šè‡ªåŠ¨é‡å¯
- éƒ¨åˆ†åº”ç”¨æ”¯æŒçƒ­æ›´æ–°ï¼ˆé€šè¿‡ä¿¡å·æˆ– APIï¼‰ï¼Œä½†å¤§éƒ¨åˆ†éœ€è¦é‡å¯

### 3. **æ•°æ®åº“é…ç½®å˜æ›´éœ€è¦è®¡åˆ’åœæœº**

- RDS ç±»å‹å˜æ›´éœ€è¦é‡å¯å®ä¾‹
- å»ºè®®åœ¨ä½å³°æœŸè¿›è¡Œ
- æå‰é€šçŸ¥ç”¨æˆ·ï¼ˆå¦‚æœæœ‰ SLA è¦æ±‚ï¼‰

---

## ğŸ“‹ æœ€ä½³å®è·µ

### æ›´æ–°ç¡¬ä»¶é…ç½®ï¼ˆCPU/Memoryï¼‰

```bash
# 1. æ›´æ–°å‚æ•°æ–‡ä»¶
# FargateCpu: "512" -> "1024"
# FargateMemory: "1024" -> "2048"

# 2. è¿è¡Œéƒ¨ç½²ï¼ˆåªæ›´æ–° ecs-services å †æ ˆï¼‰
./deploy-with-parameters.sh production

# 3. ç›‘æ§ CloudWatch Logs
aws logs tail /ecs/xituan-backend-production --follow
```

### æ›´æ–°åº”ç”¨ä»£ç ï¼ˆéœ€è¦é¢å¤–æ­¥éª¤ï¼‰

```bash
# 1. æ›´æ–°å‚æ•°æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
# ï¼ˆä¾‹å¦‚ï¼šæ›´æ–° CORSOrigin, LogLevel ç­‰ï¼‰

# 2. éƒ¨ç½²åŸºç¡€è®¾æ–½ï¼ˆå¦‚æœå‚æ•°æ–‡ä»¶æœ‰å˜æ›´ï¼‰
./deploy-with-parameters.sh production

# 3. å•ç‹¬æ›´æ–°åº”ç”¨ä»£ç ï¼ˆä¸åœ¨éƒ¨ç½²è„šæœ¬ä¸­ï¼‰
cd ../../xituan_backend
docker build -t xituan-backend:latest .
docker tag xituan-backend:latest <ECR_URI>:latest
docker push <ECR_URI>:latest

# 4. å¼ºåˆ¶ ECS æœåŠ¡ä½¿ç”¨æ–°é•œåƒï¼ˆé€šè¿‡ GitHub Actions æˆ–æ‰‹åŠ¨ï¼‰
aws ecs update-service \
    --cluster xituan-cluster-production \
    --service xituan-backend-service-production \
    --force-new-deployment
```

---

## ğŸ” å¦‚ä½•æ£€æŸ¥æ›´æ–°çŠ¶æ€

```bash
# æ£€æŸ¥ ECS æœåŠ¡çŠ¶æ€
aws ecs describe-services \
    --cluster xituan-cluster-production \
    --services xituan-backend-service-production \
    --query 'services[0].{Status:status,RunningCount:runningCount,DesiredCount:desiredCount,Deployments:deployments}'

# æ£€æŸ¥ä»»åŠ¡å®šä¹‰ç‰ˆæœ¬
aws ecs describe-task-definition \
    --task-definition xituan-backend-production \
    --query 'taskDefinition.{Revision:revision,Cpu:cpu,Memory:memory}'

# æ£€æŸ¥ CloudFormation å †æ ˆçŠ¶æ€
aws cloudformation describe-stacks \
    --stack-name xituan-ecs-services-production \
    --query 'Stacks[0].StackStatus'
```

---

## ğŸ“š æ€»ç»“

| é…ç½®ç±»å‹ | æ˜¯å¦å½±å“ ECS | æ˜¯å¦éœ€è¦é‡å¯ | å½±å“èŒƒå›´ |
|---------|-------------|--------------|---------|
| FargateCpu/Memory | âœ… æ˜¯ | âœ… æ˜¯ï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ | é›¶åœæœº |
| ç¯å¢ƒå˜é‡ | âœ… æ˜¯ | âœ… æ˜¯ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰ | é›¶åœæœº |
| DBInstanceClass | âš ï¸ é—´æ¥ | âš ï¸ é—´æ¥ï¼ˆRDS é‡å¯ï¼‰ | 5-10 åˆ†é’Ÿåœæœº |
| ALB è¯ä¹¦ | âŒ å¦ | âŒ å¦ | é›¶å½±å“ |
| **åº”ç”¨ä»£ç ï¼ˆECR é•œåƒï¼‰** | âš ï¸ éœ€è¦å•ç‹¬æ›´æ–° | âœ… æ˜¯ | é›¶åœæœº |

---

## ğŸ’¡ å…³é”®è¦ç‚¹

1. âœ… **æ›´æ–°å‚æ•°æ–‡ä»¶ + è¿è¡Œéƒ¨ç½²è„šæœ¬** = æ›´æ–°åŸºç¡€è®¾æ–½é…ç½®ï¼ˆCPUã€Memoryã€ç¯å¢ƒå˜é‡ç­‰ï¼‰
2. âš ï¸ **åº”ç”¨ä»£ç æ›´æ–°** = éœ€è¦å•ç‹¬æ„å»ºå’Œæ¨é€ Docker é•œåƒ
3. âœ… **ç¡¬ä»¶é…ç½®å˜æ›´** = å®¹å™¨ä¼šé‡æ–°åˆ›å»ºï¼ˆä½¿ç”¨ç›¸åŒçš„é•œåƒï¼‰ï¼Œä¸æ˜¯"æŒ‚è½½"
4. âœ… **æ»šåŠ¨æ›´æ–°æœºåˆ¶** = ç¡®ä¿é›¶åœæœºï¼ˆåœ¨é…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ï¼‰

