# 容量分析：0.5 vCPU + 10 数据库连接

## 📊 当前配置

- **ECS 任务**: 0.5 vCPU (512 units) + 1GB RAM
- **数据库连接池**: 10 个连接/任务
- **Auto Scaling**: 1-3 个任务
- **数据库**: db.t3.micro (2 vCPU, 1GB RAM)

---

## 🔍 详细分析

### 1. 10 个连接对于 0.5 vCPU 是否合适？

#### ✅ **答案是：合适，但需要根据实际情况调整**

**理论分析：**

```
0.5 vCPU 的处理能力：
- 相当于单核 CPU 的 50% 时间片
- Node.js 是单线程事件循环 + 异步 I/O
- 对于 I/O 密集型应用（API 服务），0.5 vCPU 通常足够

10 个数据库连接：
- 每个连接可以并发处理一个数据库查询
- 连接池会复用连接，提高效率
- 10 个连接可以处理 10 个并发数据库操作
```

**实际场景：**

| 场景 | 连接数建议 | 说明 |
|------|-----------|------|
| **简单查询为主**（< 50ms） | 10-15 个 | 查询快，连接复用率高 |
| **中等复杂度查询**（50-200ms） | 8-12 个 | 平衡连接数和等待时间 |
| **复杂查询较多**（> 200ms） | 5-8 个 | 减少连接等待，但需要优化查询 |

**你的应用特点：**
- Express.js API 服务（I/O 密集型）
- TypeORM 查询（通常 50-200ms）
- 有分页、索引优化

**结论：10 个连接对于 0.5 vCPU 是合适的起点**

---

### 2. 能支持多少用户？

#### 计算模型

**关键指标：**
1. **并发请求处理能力**（Requests Per Second, RPS）
2. **每个用户的请求频率**（Requests Per User Per Second）
3. **并发用户数** = RPS ÷ 每个用户的请求频率

#### 单任务（0.5 vCPU + 10 连接）容量

**A. 数据库连接限制（瓶颈 1）**

```
假设：
- 平均查询时间：100ms
- 10 个连接并发处理

理论吞吐量：
10 连接 × (1000ms / 100ms) = 100 请求/秒

实际考虑：
- 连接复用效率：80-90%
- 查询时间波动：50-200ms
- 非数据库操作（业务逻辑、JSON 处理）

实际吞吐量：50-80 请求/秒
```

**B. CPU 限制（瓶颈 2）**

```
0.5 vCPU 处理能力：
- Node.js 单线程事件循环
- 对于 I/O 密集型：可以处理 100-200 请求/秒（理论）
- 对于 CPU 密集型：可能只有 20-50 请求/秒

你的应用（I/O 密集型）：
- 大部分时间在等待数据库响应
- CPU 主要用于 JSON 序列化、路由处理
- 实际 CPU 利用率：30-50%

实际处理能力：80-150 请求/秒（CPU 不是瓶颈）
```

**C. 内存限制（通常不是瓶颈）**

```
1GB RAM：
- Node.js 应用：~200-300MB
- 数据库连接：10 × 10MB = 100MB
- 剩余：~600-700MB（足够）
```

#### 综合容量（单任务）

```
瓶颈：数据库连接（10 个）
实际吞吐量：50-80 请求/秒

考虑：
- 简单查询（< 50ms）：80-100 请求/秒
- 中等查询（50-200ms）：50-80 请求/秒
- 复杂查询（> 200ms）：30-50 请求/秒
```

#### 多任务扩展（1-3 个任务）

```
1 个任务：50-80 请求/秒
3 个任务：150-240 请求/秒（通过 ALB 负载均衡）
```

---

### 3. 用户支持能力

#### 用户行为假设

**典型 Web 应用用户行为：**
- **浏览用户**：每 5-10 秒一个请求（查看商品、列表）
- **活跃用户**：每 2-5 秒一个请求（搜索、筛选、下单）
- **峰值用户**：每 1-2 秒一个请求（快速操作）

**平均场景：**
- 每个用户平均：**3-5 秒一个请求** = **0.2-0.33 请求/秒/用户**

#### 容量计算

**单任务（0.5 vCPU + 10 连接）：**

```
吞吐量：50-80 请求/秒
用户请求频率：0.2-0.33 请求/秒/用户

支持并发用户数：
= 50-80 请求/秒 ÷ 0.2-0.33 请求/秒/用户
= 150-400 并发用户

保守估计：150-250 并发用户
```

**3 个任务（Auto Scaling）：**

```
吞吐量：150-240 请求/秒
支持并发用户数：
= 150-240 请求/秒 ÷ 0.2-0.33 请求/秒/用户
= 450-1200 并发用户

保守估计：500-800 并发用户
```

#### 实际用户数（非并发）

```
并发用户 vs 总用户数：
- 通常只有 1-5% 的用户同时在线
- 峰值时段可能达到 10-20%

总用户数估算：
= 并发用户数 ÷ 同时在线率

示例：
- 500 并发用户 ÷ 5% = 10,000 总注册用户
- 500 并发用户 ÷ 10% = 5,000 总注册用户（峰值）
```

---

## 📈 容量总结表

| 配置 | 吞吐量 (RPS) | 并发用户 | 总用户数（5%在线） | 总用户数（10%在线） |
|------|-------------|---------|-------------------|-------------------|
| **1 任务** | 50-80 | 150-250 | 3,000-5,000 | 1,500-2,500 |
| **3 任务** | 150-240 | 500-800 | 10,000-16,000 | 5,000-8,000 |

**注意：**
- 以上是基于**中等复杂度查询**的保守估计
- 如果查询优化良好（< 50ms），容量可以提升 50-100%
- 如果查询复杂（> 200ms），容量可能降低 30-50%

---

## ⚠️ 瓶颈分析

### 当前配置的瓶颈顺序

1. **数据库连接数**（最可能先遇到）
   - 10 个连接/任务
   - 如果查询慢，连接会被占用更久
   - **解决方案**：优化查询，或增加连接数（但需要更多 CPU）

2. **数据库性能**（db.t3.micro）
   - 2 vCPU，1GB RAM
   - 如果查询复杂，数据库可能成为瓶颈
   - **解决方案**：升级 RDS 实例

3. **ECS CPU**（通常不是瓶颈）
   - 0.5 vCPU 对于 I/O 密集型应用通常足够
   - 如果 CPU 使用率 > 80%，考虑升级到 1 vCPU

4. **ECS 内存**（通常不是瓶颈）
   - 1GB RAM 对于简单 API 服务足够

---

## 🎯 优化建议

### 立即优化（提升 30-50% 容量）

1. **优化数据库查询**
   ```sql
   -- 添加缺失索引
   -- 使用 EXPLAIN ANALYZE 分析慢查询
   -- 避免 N+1 查询
   ```

2. **启用查询缓存**
   ```typescript
   // 缓存频繁查询的数据（如商品列表、平台设置）
   // 可以减少 30-50% 的数据库查询
   ```

3. **监控实际性能**
   ```bash
   # CloudWatch 监控
   - ECS CPU 使用率
   - 数据库连接数
   - 数据库 CPU 使用率
   ```

### 短期优化（提升 2-3x 容量）

1. **升级 ECS CPU**
   ```
   0.5 vCPU → 1 vCPU (1024 units)
   可以增加连接数到 15-20 个
   容量提升：2x
   ```

2. **升级 RDS**
   ```
   db.t3.micro → db.t3.small
   更多内存，更多连接
   查询性能提升：20-30%
   ```

3. **增加任务数**
   ```
   1-3 任务 → 1-5 任务
   容量提升：线性扩展
   ```

---

## 📊 监控指标

### 关键指标阈值

| 指标 | 正常范围 | 警告阈值 | 危险阈值 |
|------|---------|---------|---------|
| **ECS CPU** | < 50% | 50-70% | > 70% |
| **数据库连接数** | < 25 | 25-35 | > 35 |
| **数据库 CPU** | < 60% | 60-80% | > 80% |
| **请求延迟** | < 200ms | 200-500ms | > 500ms |
| **错误率** | < 1% | 1-5% | > 5% |

### 容量告警

```
当以下情况发生时，考虑扩展：
1. ECS CPU 持续 > 70%
2. 数据库连接数 > 30
3. 请求延迟 > 500ms
4. 错误率 > 5%
```

---

## 💡 总结

### 10 个连接对于 0.5 vCPU 是否合适？

**✅ 合适，但需要监控和优化**

- 对于 I/O 密集型应用（你的场景），10 个连接是合理的起点
- 如果查询优化良好，可以增加到 12-15 个
- 如果查询复杂，可能需要减少到 8 个并优化查询

### 能支持多少用户？

**保守估计：**
- **1 个任务**：150-250 并发用户（3,000-5,000 总用户，5% 在线率）
- **3 个任务**：500-800 并发用户（10,000-16,000 总用户，5% 在线率）

**实际容量取决于：**
- 查询复杂度（最重要）
- 用户行为模式
- 缓存使用情况
- 数据库性能

### 建议

1. **先部署当前配置**（10 个连接）
2. **监控实际性能**（CloudWatch）
3. **根据监控数据调整**：
   - 如果连接数经常满载 → 优化查询或增加连接
   - 如果 CPU 满载 → 升级到 1 vCPU
   - 如果数据库慢 → 升级 RDS

**渐进式扩展，根据实际负载调整！**

