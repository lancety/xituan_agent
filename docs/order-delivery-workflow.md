# è®¢å•é…é€æµç¨‹æ–‡æ¡£ï¼ˆRegular / Offer / Preorderï¼‰

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°ä¸‰ç§è®¢å•æ¨¡å¼çš„å®Œæ•´é…é€æµç¨‹ï¼Œä»å‰ç«¯ä¸‹å•åˆ°é…é€å®Œæˆçš„å„ä¸ªç¯èŠ‚ã€‚

---

## ğŸ”„ æ•´ä½“æµç¨‹å›¾

```
ä¸‹å• â†’ æ”¯ä»˜ â†’ ç¡®è®¤å‘è´§ â†’ åˆ›å»ºé…é€ â†’ é…é€ä¸­ â†’ é…é€å®Œæˆ
  â†“      â†“        â†“         â†“        â†“         â†“
å‰ç«¯   å‰ç«¯     CMS/Backend  Backend  ç¬¬ä¸‰æ–¹    Backend
```

---

## 1ï¸âƒ£ Regular è®¢å•æµç¨‹ï¼ˆå®æ—¶è®¢å•ï¼‰

### 1.1 å‰ç«¯ä¸‹å•æµç¨‹

```
ç”¨æˆ·æ“ä½œï¼š
1. é€‰æ‹©å•†å“åŠ å…¥è´­ç‰©è½¦
2. é€‰æ‹©é…é€æ–¹å¼ï¼ˆé…é€/è‡ªæï¼‰
3. é€‰æ‹©é…é€åœ°å€ï¼ˆå¦‚æœé€‰æ‹©é…é€ï¼‰
   â”œâ”€ æ£€æŸ¥äº§å“"è‡ªé€"æ ‡è®°
   â”‚  â””â”€ å¦‚æœæœ‰ï¼Œåªèƒ½é€‰æ‹©åº—é“ºè‡ªé€æˆ–è‡ªæ
   â”œâ”€ è®¡ç®—è¿è´¹å’Œè·ç¦»
   â”‚  â”œâ”€ 16å…¬é‡Œå†…ï¼šUber Directï¼ˆå¦‚æœå¼€é€šï¼‰æˆ–åº—é“ºè‡ªé€
   â”‚  â””â”€ è¶…è¿‡16å…¬é‡Œï¼šSendleï¼ˆå¦‚æœå¼€é€šï¼‰æˆ–ä¸å…è®¸ä¸‹å•
   â””â”€ æ˜¾ç¤ºé…é€æœåŠ¡å•†é€‰é¡¹å’Œä»·æ ¼
4. ç¡®è®¤è®¢å•ä¿¡æ¯
5. é€‰æ‹©æ”¯ä»˜æ–¹å¼
6. æäº¤è®¢å•
```

**å‰ç«¯ä»£ç ä½ç½®**ï¼š
- `xituan_wechat_app/pages/order/regular/order-regular.ts`
- `xituan_wechat_app/components/delivery-selector/deliverySelector.ts`
- `xituan_wechat_app/lib/order-shipping.util.ts`

### 1.2 Backend å¤„ç†æµç¨‹

```
è®¢å•åˆ›å»ºï¼š
1. æ¥æ”¶è®¢å•åˆ›å»ºè¯·æ±‚
2. éªŒè¯è®¢å•ä¿¡æ¯
   â”œâ”€ æ£€æŸ¥åº“å­˜
   â”œâ”€ æ£€æŸ¥äº§å“"è‡ªé€"æ ‡è®°
   â”‚  â””â”€ å¦‚æœæœ‰ï¼ŒéªŒè¯é…é€æ–¹å¼å¿…é¡»æ˜¯åº—é“ºè‡ªé€æˆ–è‡ªæ
   â””â”€ éªŒè¯é…é€è·ç¦»ï¼ˆå¦‚æœé€‰æ‹©é…é€ï¼‰
3. åˆ›å»ºè®¢å•ï¼ˆstatus: PENDINGï¼‰
4. è®¡ç®—è¿è´¹
   â”œâ”€ æ ¹æ®è·ç¦»å’ŒæœåŠ¡å•†é€‰æ‹©é€»è¾‘
   â””â”€ è¿”å›æ¨èæœåŠ¡å•†å’Œä»·æ ¼
5. åˆ›å»ºæ”¯ä»˜è®°å½•
6. è¿”å›è®¢å•ä¿¡æ¯

è®¢å•æ”¯ä»˜åï¼š
1. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆstatus: PAIDï¼‰
2. æ›´æ–°æ”¯ä»˜è®°å½•
3. ç«‹å³åˆ›å»ºé…é€è®¢å• âš¡
   â”œâ”€ è°ƒç”¨ createDeliveryForOrder(orderId, true)
   â”‚  â””â”€ isImmediate = trueï¼ˆASAPï¼‰
   â”œâ”€ æ ¹æ®è·ç¦»å’ŒæœåŠ¡å•†é€‰æ‹©é€»è¾‘é€‰æ‹©é…é€æœåŠ¡å•†
   â”œâ”€ è°ƒç”¨å¯¹åº”æœåŠ¡å•† API åˆ›å»ºé…é€
   â”‚  â”œâ”€ Uber Direct: ç«‹å³åˆ›å»ºï¼Œç«‹å³å–è´§
   â”‚  â”œâ”€ Sendle: åˆ›å»ºè®¢å•ï¼Œå®‰æ’å–ä»¶
   â”‚  â””â”€ åº—é“ºè‡ªé€: åˆ›å»ºé…é€ä»»åŠ¡
   â””â”€ æ›´æ–°è®¢å•é…é€ä¿¡æ¯
      â”œâ”€ delivery_provider
      â”œâ”€ delivery_provider_order_id
      â”œâ”€ delivery_tracking_number
      â”œâ”€ delivery_tracking_url
      â””â”€ delivery_scheduled_pickup_timeï¼ˆç«‹å³ï¼‰
4. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆstatus: READY_FOR_DELIVERY æˆ– IN_DELIVERYï¼‰
```

**Backend ä»£ç ä½ç½®**ï¼š
- `src/domains/order/services/order.service.ts`
- `src/domains/delivery/services/delivery-management.service.ts`
- `src/domains/delivery/services/delivery-provider.service.ts`

### 1.3 ç¡®è®¤å‘è´§æµç¨‹

```
CMS æ“ä½œï¼ˆå¯é€‰ï¼Œç³»ç»Ÿå¯èƒ½è‡ªåŠ¨å¤„ç†ï¼‰ï¼š
1. æŸ¥çœ‹å¾…å‘è´§è®¢å•åˆ—è¡¨
2. ç¡®è®¤è®¢å•å·²å‡†å¤‡å¥½
3. ç‚¹å‡»"ç¡®è®¤å‘è´§"æŒ‰é’®
4. Backend æ›´æ–°è®¢å•çŠ¶æ€
   â””â”€ status: READY_FOR_DELIVERY â†’ IN_DELIVERY
```

**CMS ä»£ç ä½ç½®**ï¼š
- `xituan_cms/src/pages/orders.tsx`

### 1.4 å®¢æˆ·æŸ¥çœ‹è®¢å•è·Ÿè¸ª

```
å‰ç«¯æ˜¾ç¤ºï¼š
1. è®¢å•è¯¦æƒ…é¡µé¢
   â”œâ”€ æ˜¾ç¤ºè®¢å•çŠ¶æ€
   â”œâ”€ æ˜¾ç¤ºé…é€æœåŠ¡å•†ä¿¡æ¯
   â”‚  â”œâ”€ æœåŠ¡å•†åç§°ï¼ˆUber Direct / Sendle / åº—é“ºè‡ªé€ï¼‰
   â”‚  â”œâ”€ è¿½è¸ªå·ç 
   â”‚  â””â”€ è¿½è¸ªé“¾æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
   â”œâ”€ æ˜¾ç¤ºé…é€è¿›åº¦
   â”‚  â”œâ”€ å·²å–ä»¶
   â”‚  â”œâ”€ è¿è¾“ä¸­
   â”‚  â””â”€ å·²é€è¾¾
   â””â”€ å®æ—¶æ›´æ–°é…é€çŠ¶æ€
      â””â”€ é€šè¿‡ Webhook æˆ–è½®è¯¢æ›´æ–°

Backend åŒæ­¥é…é€çŠ¶æ€ï¼š
1. å®šæ—¶ä»»åŠ¡æˆ– Webhook æ¥æ”¶é…é€çŠ¶æ€æ›´æ–°
2. è°ƒç”¨å¯¹åº”æœåŠ¡å•† API è·å–æœ€æ–°çŠ¶æ€
   â”œâ”€ Uber Direct: GET /v1/direct/deliveries/{orderId}
   â”œâ”€ Sendle: GET /api/tracking/{trackingNumber}
   â””â”€ åº—é“ºè‡ªé€: æ‰‹åŠ¨æ›´æ–°æˆ–å†…éƒ¨ç³»ç»Ÿæ›´æ–°
3. æ›´æ–°è®¢å•çŠ¶æ€
   â”œâ”€ delivery_status
   â””â”€ è®¢å•çŠ¶æ€ï¼ˆIN_DELIVERY â†’ DELIVEREDï¼‰
```

**å‰ç«¯ä»£ç ä½ç½®**ï¼š
- `xituan_wechat_app/pages/order-detail/order-detail.ts`

**Backend ä»£ç ä½ç½®**ï¼š
- `src/domains/delivery/services/delivery-management.service.ts` (syncDeliveryStatus)

### 1.5 é…é€å®Œæˆç¡®è®¤

```
é…é€å®Œæˆï¼š
1. æœåŠ¡å•†æ ‡è®°é…é€å®Œæˆ
   â”œâ”€ Uber Direct: é…é€å‘˜ç¡®è®¤é€è¾¾
   â”œâ”€ Sendle: ç³»ç»Ÿæ›´æ–°çŠ¶æ€
   â””â”€ åº—é“ºè‡ªé€: é…é€å‘˜ç¡®è®¤é€è¾¾
2. Backend æ¥æ”¶å®Œæˆé€šçŸ¥ï¼ˆWebhook æˆ–è½®è¯¢ï¼‰
3. æ›´æ–°è®¢å•çŠ¶æ€
   â”œâ”€ status: IN_DELIVERY â†’ DELIVERED
   â”œâ”€ delivered_at: å½“å‰æ—¶é—´
   â””â”€ delivery_status: DELIVERED
4. é€šçŸ¥å®¢æˆ·
   â””â”€ å¾®ä¿¡æ¶ˆæ¯æ¨é€ï¼ˆå¯é€‰ï¼‰

å®¢æˆ·ç¡®è®¤ï¼š
1. å®¢æˆ·æŸ¥çœ‹è®¢å•è¯¦æƒ…
2. ç¡®è®¤å·²æ”¶åˆ°å•†å“
3. ç‚¹å‡»"ç¡®è®¤æ”¶è´§"æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
4. Backend æ›´æ–°è®¢å•
   â””â”€ è®¢å•æµç¨‹å®Œæˆ
```

---

## 2ï¸âƒ£ Offer è®¢å•æµç¨‹ï¼ˆå›¢è´­è®¢å•ï¼‰

### 2.1 å‰ç«¯ä¸‹å•æµç¨‹

```
ç”¨æˆ·æ“ä½œï¼š
1. é€‰æ‹© Offer å•†å“åŠ å…¥è´­ç‰©è½¦
2. æŸ¥çœ‹ Offer å‘è´§æ—¥æœŸ
3. é€‰æ‹©é…é€æ–¹å¼ï¼ˆé…é€/è‡ªæï¼‰
4. é€‰æ‹©é…é€åœ°å€ï¼ˆå¦‚æœé€‰æ‹©é…é€ï¼‰
   â”œâ”€ æ£€æŸ¥äº§å“"è‡ªé€"æ ‡è®°
   â”œâ”€ è®¡ç®—è¿è´¹å’Œè·ç¦»
   â””â”€ æ˜¾ç¤ºé…é€æœåŠ¡å•†é€‰é¡¹
5. ç¡®è®¤è®¢å•ä¿¡æ¯
6. é€‰æ‹©æ”¯ä»˜æ–¹å¼
7. æäº¤è®¢å•
```

**å‰ç«¯ä»£ç ä½ç½®**ï¼š
- `xituan_wechat_app/pages/order/offer/order-offer.ts`

### 2.2 Backend å¤„ç†æµç¨‹

```
è®¢å•åˆ›å»ºï¼š
1. æ¥æ”¶è®¢å•åˆ›å»ºè¯·æ±‚
2. éªŒè¯è®¢å•ä¿¡æ¯
   â”œâ”€ æ£€æŸ¥ Offer æ˜¯å¦æœ‰æ•ˆ
   â”œâ”€ æ£€æŸ¥åº“å­˜
   â””â”€ éªŒè¯é…é€ä¿¡æ¯
3. åˆ›å»ºè®¢å•ï¼ˆstatus: PENDING, mode: OFFERï¼‰
4. å…³è” Offer å®ä¾‹ï¼ˆmode_instance_idï¼‰
5. è®¡ç®—è¿è´¹
6. åˆ›å»ºæ”¯ä»˜è®°å½•
7. è¿”å›è®¢å•ä¿¡æ¯

è®¢å•æ”¯ä»˜åï¼š
1. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆstatus: PAIDï¼‰
2. æ›´æ–°æ”¯ä»˜è®°å½•
3. âŒ ä¸ç«‹å³åˆ›å»ºé…é€è®¢å•
   â””â”€ ç­‰å¾…å‘è´§æ—¥æœŸå‰æ‰¹é‡åˆ›å»º
```

### 2.3 ç¡®è®¤å‘è´§æµç¨‹ï¼ˆæ‰¹é‡å¤„ç†ï¼‰

```
CMS æ“ä½œï¼ˆå‘è´§æ—¥æœŸå‰ï¼‰ï¼š
1. æŸ¥çœ‹å¾…å‘è´§ Offer è®¢å•åˆ—è¡¨
2. æŒ‰å‘è´§æ—¥æœŸç­›é€‰è®¢å•
3. é€‰æ‹©åŒä¸€å¤©çš„è®¢å•
4. ç‚¹å‡»"æ‰¹é‡åˆ›å»ºé…é€"æŒ‰é’®
5. Backend æ‰¹é‡åˆ›å»ºé…é€
   â”œâ”€ è°ƒç”¨ batchCreateDeliveriesForOffer(orderIds, deliveryDate)
   â”œâ”€ æŒ‰é…é€æœåŠ¡å•†åˆ†ç»„è®¢å•
   â”‚  â”œâ”€ Uber Direct ç»„
   â”‚  â”œâ”€ Sendle ç»„
   â”‚  â””â”€ åº—é“ºè‡ªé€ç»„
   â”œâ”€ å¯¹æ¯ä¸ªæœåŠ¡å•†ç»„åˆ›å»ºæ‰¹é‡é…é€
   â”‚  â”œâ”€ Uber Direct: åŸºäºåœ°ç†ä½ç½®æ™ºèƒ½åˆ†ç»„
   â”‚  â”‚  â”œâ”€ è·å–æ‰€æœ‰è®¢å•çš„ç»çº¬åº¦
   â”‚  â”‚  â”œâ”€ è®¡ç®—è®¢å•é—´çš„è·ç¦»çŸ©é˜µ
   â”‚  â”‚  â”œâ”€ åŸºäºè·ç¦»è¿›è¡Œæ™ºèƒ½åˆ†ç»„ï¼ˆæ¯ç»„æœ€å¤š 14 ä¸ªè®¢å•ï¼‰
   â”‚  â”‚  â”‚  â””â”€ ç¡®ä¿æ¯ç»„å†…è®¢å•åœ°ç†ä½ç½®ç›¸è¿‘ï¼Œå‡å°‘é…é€æˆæœ¬
   â”‚  â”‚  â””â”€ æŒ‰ç»„åˆ›å»ºå¤šç‚¹é…é€ï¼ˆä¸€æ¬¡æ€§å–èµ°ï¼‰
   â”‚  â”œâ”€ Sendle: æ‰¹é‡åˆ›å»ºè®¢å•ï¼ˆåŒä¸€å¤©å–å•ï¼‰
   â”‚  â””â”€ åº—é“ºè‡ªé€: åˆå¹¶é…é€è·¯çº¿
   â””â”€ æ›´æ–°æ‰€æœ‰è®¢å•çš„é…é€ä¿¡æ¯
      â”œâ”€ delivery_provider
      â”œâ”€ delivery_batch_idï¼ˆåŒä¸€æ‰¹æ¬¡ï¼‰
      â””â”€ delivery_scheduled_pickup_timeï¼ˆå‘è´§æ—¥æœŸï¼‰
6. æ›´æ–°è®¢å•çŠ¶æ€
   â””â”€ status: PAID â†’ READY_FOR_DELIVERY
```

**CMS ä»£ç ä½ç½®**ï¼š
- `xituan_cms/src/pages/delivery-management.tsx`ï¼ˆæ–°å»ºï¼‰

**Backend ä»£ç ä½ç½®**ï¼š
- `src/domains/delivery/services/delivery-management.service.ts` (batchCreateDeliveriesForOffer)

### 2.4 å®¢æˆ·æŸ¥çœ‹è®¢å•è·Ÿè¸ª

```
å‰ç«¯æ˜¾ç¤ºï¼š
1. è®¢å•è¯¦æƒ…é¡µé¢
   â”œâ”€ æ˜¾ç¤ºè®¢å•çŠ¶æ€
   â”œâ”€ æ˜¾ç¤ºå‘è´§æ—¥æœŸ
   â”œâ”€ æ˜¾ç¤ºé…é€æœåŠ¡å•†ä¿¡æ¯
   â”œâ”€ æ˜¾ç¤ºé…é€è¿›åº¦
   â””â”€ æ‰¹é‡é…é€æ—¶æ˜¾ç¤ºæ‰¹æ¬¡ä¿¡æ¯

Backend åŒæ­¥é…é€çŠ¶æ€ï¼š
1. å®šæ—¶ä»»åŠ¡åŒæ­¥é…é€çŠ¶æ€
2. æ‰¹é‡æ›´æ–°åŒä¸€æ‰¹æ¬¡çš„è®¢å•çŠ¶æ€
3. æ›´æ–°è®¢å•çŠ¶æ€
```

### 2.5 é…é€å®Œæˆç¡®è®¤

```
é…é€å®Œæˆï¼š
1. æœåŠ¡å•†æ ‡è®°é…é€å®Œæˆ
2. Backend æ¥æ”¶å®Œæˆé€šçŸ¥
3. æ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€
   â””â”€ åŒä¸€æ‰¹æ¬¡çš„è®¢å•åŒæ—¶æ›´æ–°
4. é€šçŸ¥å®¢æˆ·
```

---

## 3ï¸âƒ£ Preorder è®¢å•æµç¨‹ï¼ˆé¢„çº¦è®¢å•ï¼‰

### 3.1 å‰ç«¯ä¸‹å•æµç¨‹

```
ç”¨æˆ·æ“ä½œï¼š
1. é€‰æ‹© Preorder å•†å“åŠ å…¥è´­ç‰©è½¦
2. é€‰æ‹©é…é€æ—¶æ®µï¼ˆå¦‚ "14:00-16:00"ï¼‰
3. é€‰æ‹©é…é€æ–¹å¼ï¼ˆé…é€/è‡ªæï¼‰
   â””â”€ æ³¨æ„ï¼šPreorder åªèƒ½é€‰æ‹©åº—é“ºè‡ªé€æˆ– Uber Directï¼ˆç¦ç”¨ Sendleï¼‰
4. é€‰æ‹©é…é€åœ°å€ï¼ˆå¦‚æœé€‰æ‹©é…é€ï¼‰
   â”œâ”€ æ£€æŸ¥äº§å“"è‡ªé€"æ ‡è®°
   â”œâ”€ è®¡ç®—è¿è´¹å’Œè·ç¦»
   â””â”€ æ˜¾ç¤ºé…é€æœåŠ¡å•†é€‰é¡¹ï¼ˆåªæœ‰è‡ªé€å’Œ Uber Directï¼‰
5. ç¡®è®¤è®¢å•ä¿¡æ¯
6. é€‰æ‹©æ”¯ä»˜æ–¹å¼
7. æäº¤è®¢å•
```

**å‰ç«¯ä»£ç ä½ç½®**ï¼š
- `xituan_wechat_app/pages/order/preorder/order-preorder.ts`

### 3.2 Backend å¤„ç†æµç¨‹

```
è®¢å•åˆ›å»ºï¼š
1. æ¥æ”¶è®¢å•åˆ›å»ºè¯·æ±‚
2. éªŒè¯è®¢å•ä¿¡æ¯
   â”œâ”€ æ£€æŸ¥ Preorder æ˜¯å¦æœ‰æ•ˆ
   â”œâ”€ æ£€æŸ¥æ—¶é—´æ®µæ˜¯å¦å¯ç”¨
   â”œâ”€ æ£€æŸ¥åº“å­˜
   â””â”€ éªŒè¯é…é€ä¿¡æ¯
3. åˆ›å»ºè®¢å•ï¼ˆstatus: PENDING, mode: PREORDERï¼‰
4. å…³è” Preorder å®ä¾‹ï¼ˆmode_instance_idï¼‰
5. ä¿å­˜é…é€æ—¶æ®µä¿¡æ¯
6. è®¡ç®—è¿è´¹
   â””â”€ åªè®¡ç®—åº—é“ºè‡ªé€æˆ– Uber Direct
7. åˆ›å»ºæ”¯ä»˜è®°å½•
8. è¿”å›è®¢å•ä¿¡æ¯

è®¢å•æ”¯ä»˜åï¼š
1. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆstatus: PAIDï¼‰
2. æ›´æ–°æ”¯ä»˜è®°å½•
3. âŒ ä¸ç«‹å³åˆ›å»ºé…é€è®¢å•
   â””â”€ ç­‰å¾…é…é€æ—¶æ®µå‰åˆ›å»º
```

### 3.3 ç¡®è®¤å‘è´§æµç¨‹ï¼ˆå•ç¬”é¢„å®šå–å•ï¼‰

```
CMS æ“ä½œï¼ˆé…é€æ—¶æ®µå‰ï¼‰ï¼š
1. æŸ¥çœ‹å¾…å‘è´§ Preorder è®¢å•åˆ—è¡¨
2. æŒ‰é…é€æ—¶æ®µç­›é€‰è®¢å•
3. é€‰æ‹©è®¢å•
4. ç‚¹å‡»"åˆ›å»ºé…é€"æŒ‰é’®
5. Backend åˆ›å»ºé…é€
   â”œâ”€ è°ƒç”¨ createDeliveryForPreorder(orderId, deliveryTimeSlot)
   â”œâ”€ è®¡ç®—å–ä»¶æ—¶é—´
   â”‚  â””â”€ å–ä»¶æ—¶é—´ = é…é€æ—¶æ®µå¼€å§‹æ—¶é—´ - 1å°æ—¶
   â”‚     â””â”€ ä¾‹å¦‚ï¼šé…é€æ—¶æ®µ "14:00-16:00" â†’ å–ä»¶æ—¶é—´ "13:00"
   â”œâ”€ æ£€æŸ¥äº§å“"è‡ªé€"æ ‡è®°
   â”œâ”€ éªŒè¯è·ç¦»å’ŒæœåŠ¡å•†
   â”‚  â””â”€ Preorder åªèƒ½ä½¿ç”¨åº—é“ºè‡ªé€æˆ– Uber Direct
   â”œâ”€ è°ƒç”¨å¯¹åº”æœåŠ¡å•† API åˆ›å»ºé…é€
   â”‚  â”œâ”€ Uber Direct: åˆ›å»ºé¢„çº¦é…é€ï¼ˆæŒ‡å®šå–ä»¶æ—¶é—´ï¼‰
   â”‚  â””â”€ åº—é“ºè‡ªé€: åˆ›å»ºé…é€ä»»åŠ¡ï¼ˆæŒ‡å®šå–ä»¶æ—¶é—´ï¼‰
   â””â”€ æ›´æ–°è®¢å•é…é€ä¿¡æ¯
      â”œâ”€ delivery_provider
      â”œâ”€ delivery_provider_order_id
      â”œâ”€ delivery_tracking_number
      â”œâ”€ delivery_tracking_url
      â””â”€ delivery_scheduled_pickup_timeï¼ˆé…é€æ—¶æ®µ - 1å°æ—¶ï¼‰
6. æ›´æ–°è®¢å•çŠ¶æ€
   â””â”€ status: PAID â†’ READY_FOR_DELIVERY
```

**CMS ä»£ç ä½ç½®**ï¼š
- `xituan_cms/src/pages/delivery-management.tsx`ï¼ˆæ–°å»ºï¼‰

**Backend ä»£ç ä½ç½®**ï¼š
- `src/domains/delivery/services/delivery-management.service.ts` (createDeliveryForPreorder)

### 3.4 å®¢æˆ·æŸ¥çœ‹è®¢å•è·Ÿè¸ª

```
å‰ç«¯æ˜¾ç¤ºï¼š
1. è®¢å•è¯¦æƒ…é¡µé¢
   â”œâ”€ æ˜¾ç¤ºè®¢å•çŠ¶æ€
   â”œâ”€ æ˜¾ç¤ºé…é€æ—¶æ®µï¼ˆå¦‚ "14:00-16:00"ï¼‰
   â”œâ”€ æ˜¾ç¤ºå–ä»¶æ—¶é—´ï¼ˆé…é€æ—¶æ®µ - 1å°æ—¶ï¼‰
   â”œâ”€ æ˜¾ç¤ºé…é€æœåŠ¡å•†ä¿¡æ¯
   â”œâ”€ æ˜¾ç¤ºé…é€è¿›åº¦
   â””â”€ å®æ—¶æ›´æ–°é…é€çŠ¶æ€

Backend åŒæ­¥é…é€çŠ¶æ€ï¼š
1. å®šæ—¶ä»»åŠ¡åŒæ­¥é…é€çŠ¶æ€
2. æ›´æ–°è®¢å•çŠ¶æ€
```

### 3.5 é…é€å®Œæˆç¡®è®¤

```
é…é€å®Œæˆï¼š
1. æœåŠ¡å•†æ ‡è®°é…é€å®Œæˆ
2. Backend æ¥æ”¶å®Œæˆé€šçŸ¥
3. æ›´æ–°è®¢å•çŠ¶æ€
   â””â”€ status: IN_DELIVERY â†’ DELIVERED
4. é€šçŸ¥å®¢æˆ·
```

---

## ğŸ“Š ä¸‰ç§æ¨¡å¼å¯¹æ¯”è¡¨

| æµç¨‹ç¯èŠ‚ | Regular | Offer | Preorder |
|---------|---------|-------|----------|
| **ä¸‹å•å** | ç«‹å³åˆ›å»ºé…é€ | ç­‰å¾…å‘è´§æ—¥æœŸ | ç­‰å¾…é…é€æ—¶æ®µ |
| **é…é€åˆ›å»ºæ—¶æœº** | æ”¯ä»˜åç«‹å³ | å‘è´§æ—¥æœŸå‰æ‰¹é‡ | é…é€æ—¶æ®µå‰å•ç¬” |
| **é…é€æœåŠ¡å•†** | Uber Direct / Sendle / åº—é“ºè‡ªé€ | Uber Direct / Sendle / åº—é“ºè‡ªé€ | åº—é“ºè‡ªé€ / Uber Directï¼ˆç¦ç”¨ Sendleï¼‰ |
| **æ‰¹é‡é…é€** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆåŒä¸€å¤©ï¼‰ | âŒ ä¸æ”¯æŒï¼ˆå•ç¬”ï¼‰ |
| **å–ä»¶æ—¶é—´** | ç«‹å³ï¼ˆASAPï¼‰ | å‘è´§æ—¥æœŸ | é…é€æ—¶æ®µ - 1å°æ—¶ |
| **é…é€æ—¶æ•ˆ** | å½“æ—¥è¾¾ / 1-2å¤© | 1-2å¤© | ç²¾ç¡®åˆ°å°æ—¶ |

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. è®¢å•åˆ›å»ºæ—¶çš„é…é€æœåŠ¡å•†é€‰æ‹©

```typescript
// å‰ç«¯ï¼šè®¡ç®—è¿è´¹æ—¶æ£€æŸ¥äº§å“"è‡ªé€"æ ‡è®°
const hasRequiresStoreDelivery = cartItems.some(item => 
  item.product.requiresStoreDelivery
);

// å¦‚æœæ˜¯ Preorderï¼Œç¦ç”¨ Sendle
if (orderMode === 'PREORDER') {
  // åªæ˜¾ç¤ºåº—é“ºè‡ªé€å’Œ Uber Direct
}

// Backendï¼šéªŒè¯é…é€æœåŠ¡å•†
deliveryProviderService.validateDeliveryDistance(
  distanceKm, 
  requiresStoreDelivery,
  deliveryOption
);
```

### 2. é…é€åˆ›å»ºæ—¶æœº

```typescript
// Regular è®¢å•ï¼šæ”¯ä»˜åç«‹å³åˆ›å»º
if (order.mode === epOrderMode.REGULAR && order.status === epOrderStatus.PAID) {
  await deliveryManagementService.createDeliveryForOrder(orderId, true);
}

// Offer è®¢å•ï¼šå‘è´§æ—¥æœŸå‰æ‰¹é‡åˆ›å»º
if (order.mode === epOrderMode.OFFER) {
  // åœ¨ CMS æ‰‹åŠ¨è§¦å‘æˆ–å®šæ—¶ä»»åŠ¡è§¦å‘
  await deliveryManagementService.batchCreateDeliveriesForOffer(
    orderIds, 
    deliveryDate
  );
}

// Preorder è®¢å•ï¼šé…é€æ—¶æ®µå‰åˆ›å»º
if (order.mode === epOrderMode.PREORDER) {
  await deliveryManagementService.createDeliveryForPreorder(
    orderId, 
    deliveryTimeSlot
  );
}
```

### 3. é…é€çŠ¶æ€åŒæ­¥

```typescript
// å®šæ—¶ä»»åŠ¡åŒæ­¥é…é€çŠ¶æ€
async function syncDeliveryStatus() {
  // è·å–æ‰€æœ‰é…é€ä¸­çš„è®¢å•
  const orders = await orderRepository.findByStatus(epOrderStatus.IN_DELIVERY);
  
  for (const order of orders) {
    await deliveryManagementService.syncDeliveryStatus(order.id);
  }
}
```

### 4. Webhook å¤„ç†

```typescript
// æ¥æ”¶æœåŠ¡å•† Webhook
app.post('/api/delivery/webhook/:provider', async (req, res) => {
  const { provider } = req.params;
  const { orderId, status, trackingNumber } = req.body;
  
  // æ›´æ–°è®¢å•é…é€çŠ¶æ€
  await deliveryManagementService.updateDeliveryStatus(
    orderId,
    provider,
    status,
    trackingNumber
  );
});
```

---

## ğŸ“ æ•°æ®åº“å­—æ®µè¯´æ˜

### orders è¡¨ç›¸å…³å­—æ®µ

```sql
delivery_provider VARCHAR(50)           -- é…é€æœåŠ¡å•†
delivery_provider_order_id VARCHAR(255) -- æœåŠ¡å•†è®¢å•ID
delivery_tracking_number VARCHAR(255)    -- è¿½è¸ªå·ç 
delivery_tracking_url TEXT              -- è¿½è¸ªé“¾æ¥
delivery_estimated_time TIMESTAMP       -- é¢„è®¡é€è¾¾æ—¶é—´
delivery_scheduled_pickup_time TIMESTAMP -- é¢„çº¦å–ä»¶æ—¶é—´
delivery_batch_id VARCHAR(255)           -- æ‰¹é‡é…é€æ‰¹æ¬¡IDï¼ˆOffer è®¢å•ï¼‰
```

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

### Regular è®¢å•
- [ ] å‰ç«¯ï¼šæ£€æŸ¥äº§å“"è‡ªé€"æ ‡è®°
- [ ] å‰ç«¯ï¼šæ˜¾ç¤ºé…é€æœåŠ¡å•†é€‰é¡¹
- [ ] Backendï¼šæ”¯ä»˜åç«‹å³åˆ›å»ºé…é€
- [ ] Backendï¼šè°ƒç”¨æœåŠ¡å•† API åˆ›å»ºé…é€
- [ ] Backendï¼šåŒæ­¥é…é€çŠ¶æ€
- [ ] å‰ç«¯ï¼šæ˜¾ç¤ºé…é€è¿½è¸ªä¿¡æ¯

### Offer è®¢å•
- [ ] å‰ç«¯ï¼šæ˜¾ç¤ºå‘è´§æ—¥æœŸ
- [ ] Backendï¼šä¸ç«‹å³åˆ›å»ºé…é€
- [ ] CMSï¼šæ‰¹é‡åˆ›å»ºé…é€ç•Œé¢
- [ ] Backendï¼šæ‰¹é‡åˆ›å»ºé…é€é€»è¾‘
- [ ] Backendï¼šæŒ‰æœåŠ¡å•†åˆ†ç»„
- [ ] Backendï¼šæ‰¹é‡æ›´æ–°é…é€çŠ¶æ€

### Preorder è®¢å•
- [ ] å‰ç«¯ï¼šç¦ç”¨ Sendle é€‰é¡¹
- [ ] å‰ç«¯ï¼šæ˜¾ç¤ºé…é€æ—¶æ®µé€‰æ‹©
- [ ] Backendï¼šè®¡ç®—å–ä»¶æ—¶é—´ï¼ˆé…é€æ—¶æ®µ - 1å°æ—¶ï¼‰
- [ ] Backendï¼šå•ç¬”åˆ›å»ºé…é€
- [ ] Backendï¼šé¢„çº¦é…é€æ—¶é—´
- [ ] å‰ç«¯ï¼šæ˜¾ç¤ºé…é€æ—¶æ®µå’Œå–ä»¶æ—¶é—´

---

## ğŸ”„ çŠ¶æ€æµè½¬å›¾

```
Regular:
PENDING â†’ PAID â†’ READY_FOR_DELIVERY â†’ IN_DELIVERY â†’ DELIVERED
                â†‘ (ç«‹å³åˆ›å»ºé…é€)

Offer:
PENDING â†’ PAID â†’ READY_FOR_DELIVERY â†’ IN_DELIVERY â†’ DELIVERED
                â†‘ (æ‰¹é‡åˆ›å»ºé…é€)    â†‘ (æ‰¹é‡å–å•)

Preorder:
PENDING â†’ PAID â†’ READY_FOR_DELIVERY â†’ IN_DELIVERY â†’ DELIVERED
                â†‘ (å•ç¬”åˆ›å»ºé…é€)     â†‘ (é¢„çº¦å–å•)
```

