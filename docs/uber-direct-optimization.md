# Uber Direct æ‰¹é‡é…é€ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

é’ˆå¯¹ Offer è®¢å•çš„æ‰¹é‡é…é€ï¼Œé€šè¿‡åŸºäºåœ°ç†ä½ç½®çš„åˆ†ç»„ç®—æ³•ï¼Œä¼˜åŒ– Uber Direct çš„å¤šç‚¹é…é€è·¯çº¿ï¼Œå‡å°‘é…é€æˆæœ¬ã€‚

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

1. **æœ€å°åŒ–é…é€èŒƒå›´**ï¼šç¡®ä¿æ¯ä¸ªé…é€å‘˜é…é€çš„åœ°ç‚¹æœ€å°èŒƒå›´
2. **é¿å…äº¤å‰æµªè´¹**ï¼šå‡å°‘é…é€è·¯çº¿çš„äº¤å‰å’Œé‡å¤
3. **æé«˜é…é€æ•ˆç‡**ï¼šä¼˜åŒ–é…é€è·¯çº¿ï¼Œç¼©çŸ­æ€»é…é€æ—¶é—´
4. **é™ä½æˆæœ¬**ï¼šé€šè¿‡ä¼˜åŒ–åˆ†ç»„ï¼Œå‡å°‘é…é€è´¹ç”¨

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### 1. æ•°æ®å‡†å¤‡

æ‰€æœ‰è®¢å•çš„é…é€åœ°å€éƒ½åŒ…å«ç»çº¬åº¦ä¿¡æ¯ï¼š
- ä» `delivery_address_snapshot` ä¸­è·å– `latitude` å’Œ `longitude`
- å¦‚æœæ²¡æœ‰ç»çº¬åº¦ï¼Œé€šè¿‡ Google Maps API ä»åœ°å€è·å–

### 2. è·ç¦»è®¡ç®—

#### æ–¹æ¡ˆ Aï¼šHaversine å…¬å¼ï¼ˆå¿«é€Ÿï¼Œç›´çº¿è·ç¦»ï¼‰
```typescript
// è®¡ç®—ä¸¤ç‚¹é—´çš„ç›´çº¿è·ç¦»ï¼ˆå…¬é‡Œï¼‰
function calculateHaversineDistance(lat1, lon1, lat2, lon2): number {
  const R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
  const dLat = toRadians(lat2 - lat1);
  const dLon = toRadians(lon2 - lon1);
  
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
```

#### æ–¹æ¡ˆ Bï¼šGoogle Maps Distance Matrix APIï¼ˆç²¾ç¡®ï¼Œå®é™…è·¯çº¿è·ç¦»ï¼‰
```typescript
// ä½¿ç”¨ Google Maps API è®¡ç®—å®é™…è·¯çº¿è·ç¦»
async function calculateActualDistance(
  origin: { lat: number; lng: number },
  destination: { lat: number; lng: number }
): Promise<number> {
  const result = await googleMapsService.calculateDistance(
    origin,
    destination,
    eTravelMode.DRIVING
  );
  return result.distanceKm;
}
```

**å»ºè®®**ï¼š
- åˆæœŸä½¿ç”¨ Haversine å…¬å¼ï¼ˆå¿«é€Ÿï¼Œæˆæœ¬ä½ï¼‰
- åç»­ä¼˜åŒ–ä¸º Google Maps Distance Matrix APIï¼ˆç²¾ç¡®ï¼Œä½†éœ€è¦ API è°ƒç”¨ï¼‰

### 3. åˆ†ç»„ç®—æ³•

#### ç®—æ³•é€‰æ‹©

**æ–¹æ¡ˆ Aï¼šè´ªå¿ƒç®—æ³•ï¼ˆæ¨èï¼‰**
- ä¼˜ç‚¹ï¼šç®€å•é«˜æ•ˆï¼Œæ—¶é—´å¤æ‚åº¦ O(nÂ²)
- ç¼ºç‚¹ï¼šå¯èƒ½ä¸æ˜¯å…¨å±€æœ€ä¼˜è§£
- é€‚ç”¨ï¼šè®¢å•æ•°é‡è¾ƒå°‘ï¼ˆ< 100ï¼‰

**æ–¹æ¡ˆ Bï¼šK-means èšç±»ç®—æ³•**
- ä¼˜ç‚¹ï¼šå¯ä»¥æ‰¾åˆ°æ›´ä¼˜çš„åˆ†ç»„
- ç¼ºç‚¹ï¼šéœ€è¦é¢„å…ˆç¡®å®šåˆ†ç»„æ•°é‡ï¼Œè®¡ç®—å¤æ‚åº¦è¾ƒé«˜
- é€‚ç”¨ï¼šè®¢å•æ•°é‡è¾ƒå¤šï¼ˆ> 100ï¼‰

**æ–¹æ¡ˆ Cï¼šåŸºäºè·ç¦»çš„å±‚æ¬¡èšç±»**
- ä¼˜ç‚¹ï¼šè‡ªåŠ¨ç¡®å®šåˆ†ç»„æ•°é‡
- ç¼ºç‚¹ï¼šè®¡ç®—å¤æ‚åº¦é«˜
- é€‚ç”¨ï¼šè®¢å•æ•°é‡ä¸­ç­‰

#### æ¨èå®ç°ï¼šè´ªå¿ƒç®—æ³•

```typescript
function groupOrdersByDistance(
  orders: Array<OrderWithCoordinates>,
  distanceMatrix: Map<string, number>,
  maxOrdersPerGroup: number = 14
): Array<OrderGroup> {
  const groups: OrderGroup[] = [];
  const assigned = new Set<string>();
  
  for (const order of orders) {
    if (assigned.has(order.id)) continue;
    
    // åˆ›å»ºæ–°ç»„
    const group = {
      orders: [order],
      centerLat: order.latitude,
      centerLon: order.longitude,
      maxDistance: 0
    };
    assigned.add(order.id);
    
    // è´ªå¿ƒæ·»åŠ æœ€è¿‘çš„è®¢å•
    while (group.orders.length < maxOrdersPerGroup) {
      let nearestOrder = null;
      let nearestDistance = Infinity;
      
      for (const candidate of orders) {
        if (assigned.has(candidate.id)) continue;
        
        // è®¡ç®—åˆ°ç»„å†…æ‰€æœ‰è®¢å•çš„å¹³å‡è·ç¦»
        const avgDistance = calculateAverageDistance(
          candidate,
          group.orders,
          distanceMatrix
        );
        
        if (avgDistance < nearestDistance) {
          nearestDistance = avgDistance;
          nearestOrder = candidate;
        }
      }
      
      // å¦‚æœæ‰¾åˆ°æœ€è¿‘çš„è®¢å•ä¸”è·ç¦»åœ¨åˆç†èŒƒå›´å†…ï¼ˆå¦‚ 10 å…¬é‡Œï¼‰
      if (nearestOrder && nearestDistance < 10) {
        group.orders.push(nearestOrder);
        assigned.add(nearestOrder.id);
        
        // æ›´æ–°ç»„ä¸­å¿ƒï¼ˆè´¨å¿ƒï¼‰
        updateGroupCenter(group);
        group.maxDistance = Math.max(group.maxDistance, nearestDistance);
      } else {
        break; // æ²¡æœ‰æ›´è¿‘çš„è®¢å•äº†
      }
    }
    
    groups.push(group);
  }
  
  return groups;
}
```

### 4. åˆ†ç»„å‚æ•°

- **æœ€å¤§è®¢å•æ•°**ï¼š14ï¼ˆUber Direct é™åˆ¶ï¼‰
- **æœ€å¤§ç»„å†…è·ç¦»**ï¼š10 å…¬é‡Œï¼ˆå¯é…ç½®ï¼‰
- **æœ€å°ç»„å†…è®¢å•æ•°**ï¼š1ï¼ˆå•è®¢å•ä¹Ÿå¯ä»¥ï¼‰

### 5. ä¼˜åŒ–ç­–ç•¥

#### ç­–ç•¥ 1ï¼šè·ç¦»é˜ˆå€¼
- å¦‚æœè®¢å•é—´è·ç¦»è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 10 å…¬é‡Œï¼‰ï¼Œä¸åŠ å…¥åŒä¸€ç»„
- é¿å…é…é€å‘˜éœ€è¦è·¨è¶Šå¤ªè¿œè·ç¦»

#### ç­–ç•¥ 2ï¼šç»„ä¸­å¿ƒæ›´æ–°
- æ¯æ¬¡æ·»åŠ è®¢å•åï¼Œé‡æ–°è®¡ç®—ç»„ä¸­å¿ƒï¼ˆè´¨å¿ƒï¼‰
- ç¡®ä¿ç»„ä¸­å¿ƒå§‹ç»ˆæ˜¯ç»„å†…è®¢å•çš„åœ°ç†ä¸­å¿ƒ

#### ç­–ç•¥ 3ï¼šå¤šè½®ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
- ç¬¬ä¸€è½®ï¼šåŸºäºè·ç¦»åˆ†ç»„
- ç¬¬äºŒè½®ï¼šä¼˜åŒ–åˆ†ç»„ï¼Œè°ƒæ•´è¾¹ç•Œè®¢å•
- ç¬¬ä¸‰è½®ï¼šåˆå¹¶å°ç»„åˆå¹¶æ‹†åˆ†å¤§ç»„

---

## ğŸ“Š ç¤ºä¾‹

### è¾“å…¥
- 20 ä¸ª Offer è®¢å•ï¼ŒåŒä¸€å¤©å‘è´§
- æ‰€æœ‰è®¢å•éƒ½ä½¿ç”¨ Uber Direct
- è®¢å•åœ°å€åˆ†å¸ƒåœ¨æ‚‰å°¼ä¸åŒåŒºåŸŸ

### å¤„ç†æµç¨‹

```
1. è·å–æ‰€æœ‰è®¢å•çš„ç»çº¬åº¦
   â”œâ”€ è®¢å•1: (-33.8688, 151.2093)  // æ‚‰å°¼å¸‚ä¸­å¿ƒ
   â”œâ”€ è®¢å•2: (-33.8688, 151.2093)  // æ‚‰å°¼å¸‚ä¸­å¿ƒ
   â”œâ”€ è®¢å•3: (-33.8705, 151.2071)  // æ‚‰å°¼å¸‚ä¸­å¿ƒé™„è¿‘
   â”œâ”€ è®¢å•4: (-33.9145, 151.1558)  // åŒ—æ‚‰å°¼
   â”œâ”€ è®¢å•5: (-33.9145, 151.1558)  // åŒ—æ‚‰å°¼
   â””â”€ ... (å…¶ä»–è®¢å•)

2. è®¡ç®—è·ç¦»çŸ©é˜µ
   â”œâ”€ è®¢å•1 â†” è®¢å•2: 0.5 å…¬é‡Œ
   â”œâ”€ è®¢å•1 â†” è®¢å•3: 0.3 å…¬é‡Œ
   â”œâ”€ è®¢å•1 â†” è®¢å•4: 8.2 å…¬é‡Œ
   â””â”€ ...

3. åŸºäºè·ç¦»åˆ†ç»„
   â”œâ”€ ç»„1: [è®¢å•1, è®¢å•2, è®¢å•3] (å¸‚ä¸­å¿ƒåŒºåŸŸï¼Œè·ç¦» < 1 å…¬é‡Œ)
   â”œâ”€ ç»„2: [è®¢å•4, è®¢å•5] (åŒ—æ‚‰å°¼åŒºåŸŸï¼Œè·ç¦» < 1 å…¬é‡Œ)
   â””â”€ ç»„3: [è®¢å•6, è®¢å•7, ...] (å…¶ä»–åŒºåŸŸ)

4. åˆ›å»ºå¤šç‚¹é…é€
   â”œâ”€ ç»„1 â†’ Uber Direct å¤šç‚¹é…é€ï¼ˆ3 ä¸ªé…é€ç‚¹ï¼‰
   â”œâ”€ ç»„2 â†’ Uber Direct å¤šç‚¹é…é€ï¼ˆ2 ä¸ªé…é€ç‚¹ï¼‰
   â””â”€ ç»„3 â†’ Uber Direct å¤šç‚¹é…é€ï¼ˆN ä¸ªé…é€ç‚¹ï¼‰
```

---

## ğŸ”„ å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€å®ç°
1. âœ… è·å–è®¢å•ç»çº¬åº¦
2. âœ… å®ç° Haversine è·ç¦»è®¡ç®—
3. âœ… å®ç°è´ªå¿ƒåˆ†ç»„ç®—æ³•
4. âœ… åˆ›å»ºå¤šç‚¹é…é€è®¢å•

### é˜¶æ®µäºŒï¼šä¼˜åŒ–
1. ä½¿ç”¨ Google Maps Distance Matrix API è®¡ç®—å®é™…è·ç¦»
2. å®ç° K-means èšç±»ç®—æ³•ï¼ˆå¯é€‰ï¼‰
3. æ·»åŠ å¤šè½®ä¼˜åŒ–ç­–ç•¥
4. æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜è·ç¦»çŸ©é˜µï¼‰

### é˜¶æ®µä¸‰ï¼šç›‘æ§
1. è®°å½•åˆ†ç»„æ•ˆæœï¼ˆç»„å†…å¹³å‡è·ç¦»ã€æœ€å¤§è·ç¦»ï¼‰
2. ç›‘æ§é…é€æˆæœ¬å˜åŒ–
3. æ”¶é›†é…é€å‘˜åé¦ˆ
4. æŒç»­ä¼˜åŒ–ç®—æ³•å‚æ•°

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

- **é…é€æˆæœ¬é™ä½**ï¼šé€šè¿‡ä¼˜åŒ–åˆ†ç»„ï¼Œå‡å°‘ 10-20% çš„é…é€è´¹ç”¨
- **é…é€æ•ˆç‡æå‡**ï¼šå‡å°‘é…é€æ—¶é—´ 15-25%
- **å®¢æˆ·æ»¡æ„åº¦**ï¼šæ›´å‡†ç¡®çš„é…é€æ—¶é—´é¢„ä¼°

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Uber Direct é™åˆ¶**ï¼šæœ€å¤š 14 ä¸ªé…é€ç‚¹
2. **è·ç¦»è®¡ç®—ç²¾åº¦**ï¼šHaversine å…¬å¼æ˜¯ç›´çº¿è·ç¦»ï¼Œå®é™…è·¯çº¿å¯èƒ½æ›´é•¿
3. **è®¢å•æ•°é‡**ï¼šå¦‚æœè®¢å•æ•°é‡å¾ˆå¤§ï¼Œè€ƒè™‘åˆ†æ‰¹å¤„ç†
4. **å¼‚å¸¸å¤„ç†**ï¼šå¦‚æœè®¢å•ç¼ºå°‘ç»çº¬åº¦ï¼Œéœ€è¦ä»åœ°å€è·å–æˆ–è·³è¿‡

